name: Emulator Smoke (Self-hosted)

on:
  workflow_run:
    workflows: ["Android Debug Build (APK)"]
    types: [completed]

jobs:
  smoke:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted]
    defaults:
      run:
        shell: powershell
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Build Debug APK
        run: |
          cd android
          .\gradlew.bat --no-daemon assembleDebug

      - name: Boot AVD & Install APK
        shell: powershell
        env:
          # Đặt sẵn nếu muốn bỏ qua dò package từ APK:
          # APP_ID: com.yourcompany.yourapp
          AVD_NAME: CI_CD_emu   # đổi theo AVD của bạn
        run: |
          $ErrorActionPreference = 'Stop'
      
          function Resolve-AndroidSdk {
            $candidates = @()
            if ($env:ANDROID_SDK_ROOT -and (Test-Path $env:ANDROID_SDK_ROOT)) { $candidates += $env:ANDROID_SDK_ROOT }
            if ($env:ANDROID_HOME -and (Test-Path $env:ANDROID_HOME)) { $candidates += $env:ANDROID_HOME }
            if ($env:LOCALAPPDATA) { $candidates += (Join-Path $env:LOCALAPPDATA 'Android\Sdk') }
            if ($env:USERPROFILE)  { $candidates += (Join-Path $env:USERPROFILE  'AppData\Local\Android\Sdk') }
            $candidates += 'C:\Android\Sdk'
      
            foreach ($p in $candidates | Select-Object -Unique) {
              if ($p -and (Test-Path (Join-Path $p 'platform-tools\adb.exe'))) {
                return (Resolve-Path $p).Path
              }
            }
            return $null
          }
      
          $sdk = Resolve-AndroidSdk
          if (-not $sdk) { throw "Không tìm thấy Android SDK. Hãy cài Android SDK hoặc set ANDROID_SDK_ROOT." }
      
          $ADB = Join-Path $sdk 'platform-tools\adb.exe'
          $EMU = Join-Path $sdk 'emulator\emulator.exe'
          if (-not (Test-Path $ADB)) { throw "adb not found at $ADB" }
          if (-not (Test-Path $EMU)) { throw "emulator not found at $EMU" }
      
          Write-Host "Killing stray adb (ignore errors)"
          try { taskkill /F /IM adb.exe | Out-Null } catch {}
          & $ADB kill-server
      
          $avd = if ($env:AVD_NAME) { $env:AVD_NAME } else { 'Pixel_7_API_34' }
          Write-Host "Starting emulator: $avd"
          # Với máy không có GPU phù hợp, dùng -gpu swiftshader_indirect cho ổn định:
          $gpuArg = 'host'
          # $gpuArg = 'swiftshader_indirect'
          Start-Process -FilePath $EMU -ArgumentList @(
            "-avd",$avd,
            "-no-snapshot","-no-boot-anim",
            "-gpu",$gpuArg,
            "-no-audio","-no-window"
          ) -PassThru | Out-Null
      
          Write-Host "Waiting for device..."
          & $ADB wait-for-device
      
          Write-Host "Waiting for sys.boot_completed..."
          for ($i=0; $i -lt 240; $i++) {
            $state = (& $ADB shell getprop sys.boot_completed).Trim()
            if ($state -eq '1') { break }
            Start-Sleep -Seconds 2
          }
      
          $apk = Resolve-Path "android/app/build/outputs/apk/debug/app-debug.apk"
          if (-not (Test-Path $apk)) { throw "APK not found at $apk" }
      
          Write-Host "Installing APK: $apk"
          & $ADB install -r "$apk"
      
          # Lấy packageName: ưu tiên APP_ID; nếu không có thì đọc từ chính APK bằng aapt.exe
          if ([string]::IsNullOrWhiteSpace($env:APP_ID)) {
            # Tìm aapt.exe trong build-tools version cao nhất
            $buildTools = Get-ChildItem (Join-Path $sdk 'build-tools') -Directory -ErrorAction SilentlyContinue | Sort-Object Name -Descending
            $aapt = $null
            foreach ($dir in $buildTools) {
              $cand = Join-Path $dir.FullName 'aapt.exe'
              if (Test-Path $cand) { $aapt = $cand; break }
            }
            if (-not $aapt) { throw "Không tìm thấy aapt.exe trong build-tools. Cài đặt build-tools qua SDK Manager." }
      
            $badging = & $aapt dump badging "$apk" 2>$null
            if (-not $badging) { throw "aapt dump badging failed." }
            $pkgLine = ($badging -split "`n") | Where-Object { $_ -like 'package: *' } | Select-Object -First 1
            if (-not $pkgLine) { throw "Không trích xuất được package name từ APK." }
      
            # Ví dụ: package: name='com.example.app' versionCode='1' versionName='1.0'
            $m = [regex]::Match($pkgLine, "name='([^']+)'")
            if ($m.Success) { $appId = $m.Groups[1].Value } else { throw "Parse package name thất bại." }
          } else {
            $appId = $env:APP_ID
          }
      
          Write-Host "Detected package: $appId"
          Write-Host "Launching app via monkey..."
          & $ADB shell monkey -p $appId -c android.intent.category.LAUNCHER 1
      
          # (tuỳ chọn) log/debug
          & $ADB devices -l

      - name: Smoke assertions (logcat contains)
        run: |
          $adb = Join-Path $env:ANDROID_SDK_ROOT 'platform-tools\adb.exe'
          $log = & $adb logcat -d | Select-String -Pattern "ReactNativeJS" -SimpleMatch
          if (-not $log) { throw "No ReactNativeJS log found - smoke failed" }
