name: Emulator Smoke (Self-hosted)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  smoke:
    runs-on: [self-hosted]   # máy Windows của bạn
    defaults:
      run:
        shell: powershell
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Build Debug APK
        run: |
          cd android
          .\gradlew.bat --no-daemon assembleDebug

      - name: Boot AVD & Install APK
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}   # Đảm bảo biến môi trường đã cấu hình ở runner
          AVD_NAME: CI_CD_emu                        # Đổi theo AVD của bạn
        run: |
          Write-Host "Killing stray adb (ignore error if not found)"
          try { taskkill /F /IM adb.exe } catch {}
          $adb = Join-Path $env:ANDROID_SDK_ROOT 'platform-tools\adb.exe'
          & $adb kill-server
          Start-Process -FilePath (Join-Path $env:ANDROID_SDK_ROOT 'emulator\emulator.exe') `
            -ArgumentList @("-avd","$env:AVD_NAME","-no-snapshot","-no-boot-anim","-gpu","host","-no-audio","-no-window") `
            -PassThru | Out-Null
          Write-Host "Waiting for device..."
          & $adb wait-for-device
          # Chờ boot hoàn tất (dò sys.boot_completed)
          for ($i=0; $i -lt 120; $i++) {
            $state = & $adb shell getprop sys.boot_completed
            if ($state -match "1") { break }
            Start-Sleep -Seconds 2
          }
          $apk = Resolve-Path "android/app/build/outputs/apk/debug/app-debug.apk"
          & $adb install -r "$apk"
          # Mở app (đổi ứng với applicationId của bạn)
          $appId = (Select-String -Path "android/app/build.gradle" -Pattern "applicationId\s+\"([^\"]+)\"" -AllMatches).Matches.Groups[1].Value
          if (-not $appId) { $appId = "com.yourapp" }
          & $adb shell monkey -p $appId -c android.intent.category.LAUNCHER 1

      - name: Smoke assertions (logcat contains)
        run: |
          $adb = Join-Path $env:ANDROID_SDK_ROOT 'platform-tools\adb.exe'
          $log = & $adb logcat -d | Select-String -Pattern "ReactNativeJS" -SimpleMatch
          if (-not $log) { throw "No ReactNativeJS log found - smoke failed" }
