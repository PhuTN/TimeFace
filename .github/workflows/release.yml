name: Android Release (Tag - APK)

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-apk:
    # BUILD TRÊN SELF-HOSTED (GIỐNG android-staging-firebase)
    runs-on: self-hosted
    environment: production
    timeout-minutes: 60
    permissions:
      contents: write
    outputs:
      artifact-name: app-release-apk

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # (Optional) Inject model giống workflow staging (nếu bạn đang cần nhúng ONNX khi build)
      - name: Write .env (production)
        shell: bash
        run: |
          set -e
          printf "API_URL=%s\n" "${{ secrets.API_URL }}" > .env
          echo "[ENV] Using API_URL from GitHub Environment: production"

      - name: Inject ONNX face model (not committed)
        shell: bash
        run: |
          set -e

          # Đổi đường dẫn này thành nơi bạn lưu model trên máy self-hosted
          MODEL_SRC="/home/wsladmin/timeface-models/glintr100.onnx"

          if [ ! -f "$MODEL_SRC" ]; then
            echo "Missing model at: $MODEL_SRC"
            exit 1
          fi

          mkdir -p ios/TimeFace/models
          mkdir -p android/app/src/main/assets
          mkdir -p android/app/src/main/assets/models

          cp "$MODEL_SRC" ios/TimeFace/models/glintr100.onnx
          cp "$MODEL_SRC" android/app/src/main/assets/glintr100.onnx
          cp "$MODEL_SRC" android/app/src/main/assets/models/glintr100.onnx

          echo "Model injected:"
          ls -lh ios/TimeFace/models/glintr100.onnx
          ls -lh android/app/src/main/assets/glintr100.onnx
          ls -lh android/app/src/main/assets/models/glintr100.onnx

      # (Optional) Decode keystore nếu bạn muốn ký APK release
      - name: Decode keystore
        if: env.SHOULD_SIGN == 'true'
        env:
          KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_B64" | base64 -d > android/app/release.keystore

      - name: Set signing env
        if: env.SHOULD_SIGN == 'true'
        run: |
          echo "SIGNING_STORE_FILE=release.keystore" >> $GITHUB_ENV
          echo "SIGNING_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> $GITHUB_ENV
          echo "SIGNING_STORE_PASSWORD=${{ secrets.ANDROID_STORE_PASSWORD }}" >> $GITHUB_ENV
          echo "SIGNING_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> $GITHUB_ENV

      - name: Build release APK (only)
        working-directory: android
        run: |
          chmod +x ./gradlew
          ./gradlew --no-daemon --stacktrace --build-cache --parallel assembleRelease

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: android/app/build/outputs/apk/release/*.apk
          if-no-files-found: error

  create-github-release:
    needs: build-apk
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: app-release-apk
          path: ./dist

      - name: Rename APK
        shell: bash
        run: |
          set -e
          APK=$(ls -1 ./dist/*.apk | head -n 1)
          NEW="./dist/timeface-apk-${GITHUB_REF_NAME}.apk"
          mv "$APK" "$NEW"
          echo "Renamed: $NEW"
          ls -lh ./dist

      - name: Create GitHub Release (attach APK)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./dist/timeface-apk-*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
